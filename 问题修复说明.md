# 🔧 问题修复说明

## 修复的问题

### 问题1：保存卡牌失败 ❌ → ✅

**原因：**
- API地址硬编码为 `http://localhost:8000/api`
- 在Android原生应用中，`localhost` 指向的是设备本身，而不是运行FastAPI的服务器
- 导致无法连接到后端服务器

**解决方案：**
1. ✅ 将API地址改为可配置，存储在localStorage中
2. ✅ 添加API连接检测功能，启动时自动检测
3. ✅ 新增设置页面，可配置服务器地址
4. ✅ 支持局域网IP地址配置（如：`http://192.168.1.100:8000/api`）
5. ✅ 添加测试连接功能，方便验证配置是否正确

---

### 问题2：图片输入方式不便 ❌ → ✅

**原因：**
- 原来是通过文本框输入图片链接
- 在手机端无法方便地输入图片链接
- 用户体验差

**解决方案：**
1. ✅ 集成Capacitor Camera插件 (`@capacitor/camera@6.0.0`)
2. ✅ 添加"从图库选择"功能
3. ✅ 添加"拍照"功能
4. ✅ 添加图片预览功能
5. ✅ 保留输入图片链接的选项（作为备选）
6. ✅ 图片自动转换为Base64格式保存

---

## 使用说明

### 1. 重新构建APK

由于修改了前端代码，需要重新构建APK：

```bash
# 在你的本地环境
cd social-card-game/android
./gradlew assembleDebug
```

或在GitHub Actions中自动构建。

### 2. 配置服务器地址

安装新版本APK后：

1. **启动应用**
2. **点击底部导航的"设置"** ⚙️
3. **在"API地址"输入框中输入服务器地址**
   
   **重要提示：**
   - 如果你的手机和服务器在同一局域网，请使用服务器的局域网IP
   - 例如：`http://192.168.1.100:8000/api`
   - 不要使用 `localhost`，因为在手机上localhost指向的是手机本身
   - 不要使用 `127.0.0.1`，原因同上

4. **点击"测试连接"验证配置是否正确**
5. **点击"保存配置"**

### 3. 使用图片功能

在新增或编辑卡牌时：

**方式一：从图库选择**
1. 点击"📷 从图库选择"按钮
2. 在相册中选择图片
3. 图片会自动显示预览
4. 点击保存

**方式二：拍照**
1. 点击"📸 拍照"按钮
2. 拍摄照片
3. 图片会自动显示预览
4. 点击保存

**方式三：输入图片链接**
1. 在"输入图片链接"输入框中输入URL
2. 点击保存

### 4. 测试保存功能

配置好服务器地址后：

1. 点击"✨ 新增卡牌人物"
2. 填写必要信息（姓名）
3. 选择或输入照片（可选）
4. 点击"💾 保存卡牌"
5. 如果配置正确，会显示"✨ 卡牌创建成功"

---

## 服务器获取局域网IP

### Windows系统：
```cmd
ipconfig
```
找到"IPv4 地址"，例如：`192.168.1.100`

### macOS系统：
```bash
ifconfig | grep "inet "
```
找到类似 `192.168.1.100` 的地址

### Linux系统：
```bash
ip addr show | grep "inet "
```
找到类似 `192.168.1.100` 的地址

---

## 常见问题

### Q: 还是提示"无法连接到服务器"？
**A:**
1. 确认服务器正在运行：`python src/server.py`
2. 确认手机和服务器在同一网络（连接同一WiFi）
3. 确认服务器防火墙允许8000端口
4. 确认输入的IP地址正确
5. 尝试在设置中点击"测试连接"

### Q: 图片选择后不显示预览？
**A:**
1. 确认已授予应用相册和相机权限
2. 检查是否安装了最新版本的APK
3. 尝试重启应用

### Q: Base64图片太大导致保存失败？
**A:**
1. 选择较小的图片（建议小于2MB）
2. 或者使用图片链接方式
3. 未来版本将优化图片压缩功能

---

## 技术细节

### 修改的文件

1. `assets/app.html`
   - 修改API地址配置方式
   - 添加图片选择功能
   - 添加设置页面
   - 优化错误提示

2. `package.json`
   - 添加 `@capacitor/camera@6.0.0` 依赖

3. `android/capacitor.settings.gradle`
   - 添加Camera插件配置

4. `android/app/capacitor.build.gradle`
   - 添加Camera插件依赖

### 关键代码

**API地址配置：**
```javascript
let API_BASE = localStorage.getItem('api_base') || 'http://localhost:8000/api';
```

**图片选择：**
```javascript
const image = await Capacitor.Plugins.Camera.getPhoto({
    quality: 90,
    allowEditing: false,
    resultType: 'base64',
    source: 'PHOTOLIBRARY'
});
```

**保存Base64图片：**
```javascript
const finalPhotoUrl = photoBase64 ? 
    `data:image/jpeg;base64,${photoBase64}` : 
    (photoUrl || null);
```

---

## 后续优化计划

1. [ ] 添加图片自动压缩功能
2. [ ] 支持上传图片到服务器
3. [ ] 添加更多相机选项（裁剪、滤镜等）
4. [ ] 优化Base64图片存储性能
5. [ ] 添加离线模式支持

---

## 需要帮助？

如果遇到问题，请：
1. 查看常见问题部分
2. 检查设置中的API地址配置
3. 尝试测试连接功能
4. 查看应用日志（如需要）

**祝你使用愉快！** 🎮✨
